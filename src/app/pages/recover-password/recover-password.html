<main>
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-6 col-xl-5">
        <div class="card shadow-lg border-0 rounded-3">
          <div class="card-header bg-primary text-white text-center py-4 rounded-top">
            <i class="bi bi-key-fill fs-1 mb-2"></i>
            <h2 class="mb-1">Recuperar Contraseña</h2>
            <p class="mb-0 opacity-75">Restablece el acceso a tu cuenta</p>
          </div>

          <div class="card-body p-4 p-md-5">
            <!-- Mensajes globales -->
            @if (errorMessage) {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              {{ errorMessage }}
              <button
                type="button"
                class="btn-close"
                (click)="errorMessage = ''"
                aria-label="Close"
              ></button>
            </div>
            } @if (successMessage) {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              <i class="bi bi-check-circle-fill me-2"></i>
              {{ successMessage }}
              <button
                type="button"
                class="btn-close"
                (click)="successMessage = ''"
                aria-label="Close"
              ></button>
            </div>
            } @if (infoMessage) {
            <div class="alert alert-info alert-dismissible fade show" role="alert">
              <i class="bi bi-info-circle-fill me-2"></i>
              {{ infoMessage }}
              <button
                type="button"
                class="btn-close"
                (click)="infoMessage = ''"
                aria-label="Close"
              ></button>
            </div>
            }

            <!-- Paso 1: Solicitar email -->
            @if (currentStep === 'email') {
            <div>
              <form [formGroup]="emailForm" (ngSubmit)="onRequestCode()" novalidate>
                <div class="alert alert-info" role="alert">
                  <i class="bi bi-info-circle me-2"></i>
                  Ingresa tu correo electrónico y te enviaremos un código de verificación.
                </div>

                <div class="mb-3">
                  <label for="email" class="form-label fw-semibold">
                    <i class="bi bi-envelope-fill text-primary me-2"></i>Correo electrónico
                  </label>
                  <input
                    type="email"
                    class="form-control form-control-lg"
                    [class.is-invalid]="isFieldInvalid(emailForm, 'email')"
                    id="email"
                    formControlName="email"
                    placeholder="tu@email.com"
                  />
                  @if (isFieldInvalid(emailForm, 'email')) {
                  <div class="invalid-feedback d-block">
                    {{ getFieldError(emailForm, 'email') }}
                  </div>
                  }
                </div>

                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-primary btn-lg" [disabled]="isLoading">
                    @if (isLoading) {
                    <span
                      class="spinner-border spinner-border-sm me-2"
                      role="status"
                      aria-hidden="true"
                    ></span>
                    Enviando... } @else {
                    <i class="bi bi-send me-2"></i>Enviar código }
                  </button>
                  <a
                    routerLink="/sign-in"
                    class="btn btn-outline-secondary btn-lg"
                    [class.disabled]="isLoading"
                  >
                    <i class="bi bi-arrow-left me-2"></i>Volver al inicio
                  </a>
                </div>
              </form>
            </div>
            }

            <!-- Paso 2: Ingresar código y nueva contraseña -->
            @if (currentStep === 'code') {
            <div>
              <form [formGroup]="passwordForm" (ngSubmit)="onChangePassword()" novalidate>
                <div class="mb-3">
                  <label for="code" class="form-label fw-semibold">
                    <i class="bi bi-shield-lock text-primary me-2"></i>Código de verificación
                  </label>
                  <input
                    type="text"
                    class="form-control form-control-lg"
                    [class.is-invalid]="isFieldInvalid(passwordForm, 'code')"
                    id="code"
                    formControlName="code"
                    placeholder="Ingresa el código de 6 dígitos"
                    maxlength="6"
                  />
                  @if (isFieldInvalid(passwordForm, 'code')) {
                  <div class="invalid-feedback d-block">
                    {{ getFieldError(passwordForm, 'code') }}
                  </div>
                  }
                </div>

                <div class="mb-3">
                  <label for="newPassword" class="form-label fw-semibold">
                    <i class="bi bi-lock-fill text-primary me-2"></i>Nueva contraseña
                  </label>
                  <input
                    type="password"
                    class="form-control form-control-lg"
                    [class.is-invalid]="isFieldInvalid(passwordForm, 'newPassword')"
                    id="newPassword"
                    formControlName="newPassword"
                    placeholder="Ingresa tu nueva contraseña"
                  />
                  @if (isFieldInvalid(passwordForm, 'newPassword')) {
                  <div class="invalid-feedback d-block">
                    {{ getFieldError(passwordForm, 'newPassword') }}
                  </div>
                  }
                  <div class="form-text">
                    <small>
                      <strong>Requisitos:</strong> 8-20 caracteres, mayúscula, número y carácter
                      especial (!@#$%^&*)
                    </small>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="confirmPassword" class="form-label fw-semibold">
                    <i class="bi bi-shield-lock-fill text-primary me-2"></i>Confirmar contraseña
                  </label>
                  <input
                    type="password"
                    class="form-control form-control-lg"
                    [class.is-invalid]="
                      isFieldInvalid(passwordForm, 'confirmPassword') || isPasswordMismatch()
                    "
                    id="confirmPassword"
                    formControlName="confirmPassword"
                    placeholder="Repite tu nueva contraseña"
                  />
                  @if (isFieldInvalid(passwordForm, 'confirmPassword')) {
                  <div class="invalid-feedback d-block">
                    {{ getFieldError(passwordForm, 'confirmPassword') }}
                  </div>
                  } @if (isPasswordMismatch()) {
                  <div class="invalid-feedback d-block">Las contraseñas no coinciden</div>
                  }
                </div>

                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-primary btn-lg" [disabled]="isLoading">
                    @if (isLoading) {
                    <span
                      class="spinner-border spinner-border-sm me-2"
                      role="status"
                      aria-hidden="true"
                    ></span>
                    Cambiando... } @else {
                    <i class="bi bi-check-circle me-2"></i>Cambiar contraseña }
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-lg"
                    (click)="onReset()"
                    [disabled]="isLoading"
                  >
                    <i class="bi bi-arrow-clockwise me-2"></i>Reintentar
                  </button>
                </div>
              </form>
            </div>
            }
          </div>

          <div class="card-footer bg-light text-center py-3">
            <small class="text-muted">
              ¿Recordaste tu contraseña?
              <a routerLink="/sign-in" class="text-primary text-decoration-none fw-semibold"
                >Inicia sesión aquí</a
              >
            </small>
          </div>
        </div>

        <div class="row mt-4 text-center">
          <div class="col-12">
            <div class="p-3">
              <i class="bi bi-shield-check text-primary fs-2"></i>
              <p class="small mb-0 mt-2">Tu seguridad es nuestra prioridad</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
